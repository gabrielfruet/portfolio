---
import { type CollectionEntry, getCollection } from "astro:content";
import Header from "../../components/Header.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

type Props = CollectionEntry<"blog">;

const post = Astro.props;
const { Content, headings } = await post.render();
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  articleDate={post.data.pubDate}
>
  <Header />

  <main class="max-w-2xl">
    <article>
      <header class="mb-10">
        <h1
          class="font-mono text-2xl md:text-3xl font-bold text-white mb-4 leading-tight"
        >
          {post.data.title}
        </h1>
        <div class="flex items-center gap-4 text-sm text-neutral-500 font-mono">
          <time datetime={post.data.pubDate.toISOString()}>
            {
              post.data.pubDate.toLocaleDateString("en-US", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })
            }
          </time>
          {
            post.data.tags && (
              <div class="flex gap-2">
                <span>/</span>
                {post.data.tags.map((tag) => (
                  <span>#{tag}</span>
                ))}
              </div>
            )
          }
        </div>
      </header>

      <div
        class="prose prose-invert prose-neutral max-w-none
        prose-headings:font-mono prose-headings:text-white
        prose-p:text-neutral-300 prose-p:leading-8 prose-p:mb-6
        prose-li:mb-2
        prose-a:text-blue-400 prose-a:no-underline hover:prose-a:underline
        prose-code:font-mono prose-code:bg-neutral-900 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-neutral-200
        prose-pre:bg-neutral-900 prose-pre:border prose-pre:border-neutral-800
        prose-img:rounded-md"
      >
        <TableOfContents headings={headings} />
        <Content />
      </div>
    </article>
  </main>
  <script
    type="application/ld+json"
    slot="head"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      headline: post.data.title,
      description: post.data.description,
      datePublished: post.data.pubDate.toISOString(),
      dateModified: (post.data.updatedDate || post.data.pubDate).toISOString(),
      author: {
        "@type": "Person",
        name: "Gabriel Fruet",
        url: Astro.site,
      },
      url: new URL(Astro.url.pathname, Astro.site).href,
    })}
  />
</BaseLayout>
