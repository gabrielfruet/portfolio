---
import type { MarkdownHeading } from "astro";

interface Props {
    headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// Calculate the minimum depth present to determine top-level headings
const minDepth = headings.length
    ? Math.min(...headings.map((h) => h.depth))
    : 2;
const toc = headings.filter((h) => h.depth <= minDepth + 1);
---

{
    toc.length > 0 && (
        <nav class="toc my-8 border border-neutral-800 rounded-lg overflow-hidden bg-[#111] shadow-sm">
            <button
                class="toc-toggle w-full flex items-center gap-2 p-3 bg-[#1a1a1a] text-left cursor-pointer focus:outline-none group text-neutral-300 hover:text-white transition-colors duration-200 border-b border-neutral-800"
                aria-expanded="true"
                aria-controls="toc-content"
            >
                <div class="toc-icon transform transition-transform duration-300 text-neutral-500 group-hover:text-neutral-300">
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="12"
                        height="12"
                        viewBox="0 0 24 24"
                        fill="currentColor"
                    >
                        <path d="M12 21l-12-18h24z" />
                    </svg>
                </div>
                <span class="font-sans text-sm font-medium">
                    Table of Contents
                </span>
            </button>
            <div
                id="toc-content"
                class="toc-content grid grid-rows-[1fr] transition-[grid-template-rows] duration-300 ease-in-out bg-[#111]"
            >
                <div class="overflow-hidden">
                    <ul class="text-sm py-4 px-6 space-y-2 list-disc list-outside ml-4 marker:text-neutral-600">
                        {toc.map((heading) => (
                            <li
                                class:list={[
                                    "transition-colors duration-200 pl-1",
                                    heading.depth === minDepth
                                        ? "text-neutral-300 hover:text-white hover:underline decoration-neutral-600 underline-offset-4"
                                        : "ml-6 text-neutral-400 hover:text-white hover:underline decoration-neutral-600 underline-offset-4",
                                ]}
                            >
                                <a
                                    href={`#${heading.slug}`}
                                    class="focus:outline-none focus:text-blue-400"
                                >
                                    {heading.text}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
        </nav>
    )
}

<script>
    function setupTOC() {
        const toggles = document.querySelectorAll(".toc-toggle");

        toggles.forEach((toggle) => {
            toggle.addEventListener("click", () => {
                const content = toggle.nextElementSibling as HTMLElement;
                const icon = toggle.querySelector(
                    ".toc-icon",
                ) as HTMLElement | null;
                const isExpanded =
                    toggle.getAttribute("aria-expanded") === "true";

                // Toggle state
                toggle.setAttribute("aria-expanded", (!isExpanded).toString());

                // Animate content
                if (content) {
                    content.style.gridTemplateRows = isExpanded ? "0fr" : "1fr";
                }

                // Rotate icon
                if (icon) {
                    icon.style.transform = isExpanded
                        ? "rotate(-90deg)"
                        : "rotate(0deg)";
                }
            });
        });
    }

    // Run on invalidation or load (Astro View Transitions handling if present, otherwise explicit call)
    setupTOC();
    document.addEventListener("astro:page-load", setupTOC);
</script>
